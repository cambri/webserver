
server {

    listen {{ config.port.http|default(80) }};

    {% if ssl %}
    listen {{ config.port.https|default(443) }} ssl spdy;
    ssl_certificate_key {{ ssl.pathKey }};
    ssl_certificate {{ ssl.pathPem }};
    {% endif %}



    # server hostnames
    server_name {% if hostname %}{{ hostname.hostname }}{% else %}{{ hostnames.lists('hostname')|join(" ") }}{% endif %};

    # redirect any www domain to non-www
    if ( $host ~* ^www\.(.*) ) {
        set             $host_nowww     $1;
        rewrite         ^(.*)$          $scheme://$host_nowww$1 permanent;
    }

    # root path of website; serve files from here
    root                        {{ public_path }};
    index                       index.php;


    # log handling
    access_log          {{ log_path ~ '.access.log' }};
    error_log           {{ log_path ~ '.error.log' }} notice;

    {% if website.directory.media() %}
    # attempt to passthrough to image service
    location ~* ^/media/(.+)$ {
        proxy_pass 		    $scheme://media.{% if hostname %}{{ hostname.hostname }}{% else %}{{ hostnames.lists('hostname')|first }}{% endif %}/$1;
        proxy_cache 	    img_cache_hyn_mt_{{ website.id }};
        proxy_cache_key 	"$host$document_uri";
        proxy_cache_valid 	200 1d;
        proxy_cache_valid 	any 1m;
        proxy_cache_use_stale error timeout invalid_header updating;
    }
    {% endif %}

    {% if website.directory.cache() %}
    # map public cache folder to private domain folder
    location /cache/ {
        alias 		{{ website.directory.cache() }};
    }
    {% endif %}

    location / {
        index           index.php;
        try_files       $uri $uri/ $uri/index.php?$args /index.php?$args;
    }
    # pass the PHP scripts to FastCGI server from upstream phpfcgi
    location ~ \.php(/|$) {
        fastcgi_pass    127.0.0.1:{{ fpm_port + website.id }};
        include         fastcgi_params;

        fastcgi_split_path_info ^(.+\.php)(/.*)$;

        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }
}




{% if website.directory.media() %}
#
#   Media subdomain proxy
#       Mutates images from the media tenant directory
#
server {
    listen {{ config.port.http|default(80) }};

    {% if ssl %}
        listen {{ config.port.https|default(443) }} ssl spdy;
        ssl_certificate_key {{ ssl.pathKey }};
        ssl_certificate {{ ssl.pathPem }};
    {% endif %}


    # log handling
    access_log          {{ log_path ~ '.access.log' }};
    error_log           {{ log_path ~ '.error.log' }} notice;

    server_name {% if hostname %}media.{{ hostname.hostname }}{% else %}{% for hostname in hostnames.lists('hostname') %}media.{{ hostname }}{% if loop.last != true %} {% endif %}{% endfor %}{% endif %};

    # allow cross origin access
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Request-Method GET;


    # resizing
    location ~* ^/resize/([\d\-]+)/([\d\-]+)/(.+)$ {
        alias 		{{ website.directory.media() }}$3;
        image_filter 	resize $1 $2;
        image_filter_buffer 10M;
        error_page 	415 = /empty;
    }

    # cropping
    location ~* ^/crop/([\d\-]+)/([\d\-]+)/(.+)$ {
        alias 		{{ website.directory.media() }}$3;
        image_filter crop $1 $2;
        image_filter_buffer 10M;
        error_page 	415 = /empty;
    }

    # rotating
    location ~* ^/rotate/([\d\-]+)/(.+)$ {
        alias 		{{ website.directory.media() }}$2;
        image_filter_buffer         10M;
        image_filter                rotate $1;
        error_page 	415 = /empty;
    }

    # passthrough
    location ~* ^/(.+)$ {
        alias 		{{ website.directory.media() }}/$1;
        error_page 	415 = /empty;
    }

    # not found
    location / {
        return 404;
    }

    # not found
    location = /empty {
        return 404;
    }
}
{% endif %}